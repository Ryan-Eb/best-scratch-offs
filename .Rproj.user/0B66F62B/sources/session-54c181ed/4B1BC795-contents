library(tidyverse)
library(lubridate)

setwd("/Users/jennaryan/Documents/GitHub/all_lotto_states/daily_csv")
df <- list.files("/Users/jennaryan/Documents/GitHub/all_lotto_states/daily_csv") %>% 
  read_csv()

ticket_prices <-df %>% 
  select(state,game_number,ticket_price) %>% distinct(.keep_all = TRUE)

game_names <- read_csv("/Users/jennaryan/Documents/GitHub/all_lotto_states/game_name_list.csv")


##summary table#.
 tsd <- df %>% 
  drop_na() %>% 
  group_by(state,game_number,scrape_date) %>% 
  summarise(number_tickets = sum(total_prizes) * mean(overall_odds),
            tickets_sold = sum(prizes_claimed) * mean(overall_odds)) %>%
  left_join(ticket_prices, by = c("state","game_number")) %>% 
  mutate(dollar_spend = tickets_sold * ticket_price) %>% 
  group_by(state,game_number) %>% 
  arrange(game_number,scrape_date) %>% 
  mutate(diff_tickets_sold = tickets_sold - lag(tickets_sold)) %>% 
  mutate(diff_dollar_spend = dollar_spend - lag(dollar_spend)) %>% 
  mutate(diff_days = as.numeric(scrape_date - lag(scrape_date))) %>% 
  mutate(tickets_sold_per_day = diff_tickets_sold / diff_days) %>% 
  mutate(dollar_spend_per_day = diff_dollar_spend / diff_days) %>% 
  ungroup() %>% 
  group_by(state,scrape_date) %>% 
  arrange(scrape_date) %>% 
  drop_na() %>% 
  summarise(dollar_spend_per_day = sum(dollar_spend_per_day),
            tickets_sold_per_day = sum(tickets_sold_per_day))

###dollar spend per day by state            
 df %>% 
   drop_na() %>% 
   group_by(state,game_number,scrape_date) %>% 
   summarise(number_tickets = sum(total_prizes) * mean(overall_odds),
             tickets_sold = sum(prizes_claimed) * mean(overall_odds)) %>%
   left_join(ticket_prices, by = c("state","game_number")) %>% 
   mutate(dollar_spend = tickets_sold * ticket_price) %>% 
   group_by(state,game_number) %>% 
   arrange(game_number,scrape_date) %>% 
   mutate(diff_tickets_sold = tickets_sold - lag(tickets_sold)) %>% 
   mutate(diff_dollar_spend = dollar_spend - lag(dollar_spend)) %>% 
   mutate(diff_days = as.numeric(scrape_date - lag(scrape_date))) %>% 
   mutate(tickets_sold_per_day = diff_tickets_sold / diff_days) %>% 
   mutate(dollar_spend_per_day = diff_dollar_spend / diff_days) %>% 
   ungroup() %>% 
   group_by(state,scrape_date) %>% 
   arrange(scrape_date) %>% 
   drop_na() %>% 
   summarise(dollar_spend_per_day = sum(dollar_spend_per_day)) %>% 
   ggplot(aes(x = scrape_date, y = dollar_spend_per_day, color = state))+
   geom_line()+
   geom_point()+
   theme_bw()+
   scale_y_continuous(labels = scales::label_dollar())
 
 
 ###current ROI###
 
 bgt <- df %>% 
   group_by(state,game_number,scrape_date) %>% 
   summarise(total_prize_amount = sum(total_prizes * prize_amount),
             total_prize_amount_remaining = sum(prizes_remaining * prize_amount),
             number_tickets = sum(total_prizes) * mean(overall_odds),
             tickets_sold = sum(prizes_claimed) * mean(overall_odds)) %>% 
   ungroup() %>% 
   left_join(ticket_prices, by = c("state","game_number")) %>% 
   mutate(initial_roi = total_prize_amount / (number_tickets * ticket_price),
          current_roi = total_prize_amount_remaining / ((number_tickets - tickets_sold)*ticket_price)) %>% 
   group_by(state,ticket_price) %>% 
   filter(scrape_date == max(scrape_date)) %>% 
   drop_na()
 
 
 state_spend <- df %>% 
   drop_na() %>% 
   group_by(state,game_number,scrape_date) %>% 
   summarise(number_tickets = sum(total_prizes) * mean(overall_odds),
             tickets_sold = sum(prizes_claimed) * mean(overall_odds)) %>%
   left_join(ticket_prices, by = c("state","game_number")) %>% 
   mutate(dollar_spend = tickets_sold * ticket_price) %>% 
   group_by(state,game_number) %>% 
   arrange(game_number,scrape_date) %>% 
   mutate(diff_tickets_sold = tickets_sold - lag(tickets_sold)) %>% 
   mutate(diff_dollar_spend = dollar_spend - lag(dollar_spend)) %>% 
   mutate(diff_days = as.numeric(scrape_date - lag(scrape_date))) %>% 
   mutate(tickets_sold_per_day = diff_tickets_sold / diff_days) %>% 
   mutate(dollar_spend_per_day = diff_dollar_spend / diff_days) %>% 
   ungroup() %>% 
   group_by(state,scrape_date) %>% 
   arrange(scrape_date) %>% 
   drop_na() %>% 
   summarise(dollar_spend_per_day = sum(dollar_spend_per_day)) 
